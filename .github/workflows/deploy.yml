# .github/workflows/deploy.yml

name: Deploy Spring Boot + React to EC2 (Blue-Green)

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    name: Build and Deploy (Blue-Green)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Connect to EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # --- 0. ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë³´ì¥ ---
            # 'maple-db' ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ docker-compose.db.ymlì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.
            if [ ! "$(docker ps -q -f name=maple-db)" ]; then
              echo "Database container not found. Starting a new one..."
              # DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ìœ„í•œ ì„ì‹œ .env íŒŒì¼ ìƒì„±
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" > ~/db.env
              # docker-compose.db.yml íŒŒì¼ì´ EC2 í™ˆ ë””ë ‰í† ë¦¬ì— ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì‹¤í–‰
              docker compose -f ~/docker-compose.db.yml --env-file ~/db.env up -d
              rm ~/db.env # ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ íŒŒì¼ ì¦‰ì‹œ ì‚­ì œ
            else
              echo "Database container is already running."
            fi

            # --- 1. ì†ŒìŠ¤ì½”ë“œ ì¤€ë¹„ ---
            if [ ! -d "~/app" ]; then
              git clone -b deploy https://github.com/malanjari/mapleLand-Server.git ~/app
            fi
            cd ~/app
            git pull origin deploy

            # --- 1.5. ì„œë²„ í™˜ê²½ ìë™ ì„¤ì • ---
            if ! java -version 2>&1 | grep -q "openjdk 17"; then
              sudo apt-get update -y && sudo apt-get install -y openjdk-17-jdk
            fi
            if ! command -v node &> /dev/null || ! node -v | grep -q "v20."; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # --- 2. ì„œë²„ì—ì„œ ì§ì ‘ ë¹Œë“œ ---
            chmod +x ./backend/gradlew
            ./backend/gradlew build -x test -p ./backend
            cd ./frontend && npm ci && npm run build && cd ..

            # --- 3. Dockerë¡œ ë¸”ë£¨/ê·¸ë¦° ë°°í¬ ---
            echo "ğŸš€ Starting Blue-Green Deployment..."

            echo "DB_URL=${{ secrets.DB_URL }}" > .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}" >> .env
            echo "DISCORD_CLIENT_SECRET=${{ secrets.DISCORD_CLIENT_SECRET }}" >> .env
            echo "DISCORD_REDIRECT_URI=${{ secrets.DISCORD_REDIRECT_URI }}" >> .env

            IS_BLUE_RUNNING=$(docker ps --filter "name=blue-nginx-1" --format "{{.Names}}")
            if [ -n "$IS_BLUE_RUNNING" ]; then
              TARGET_GROUP=green
              OLD_GROUP=blue
            else
              TARGET_GROUP=blue
              OLD_GROUP=green
            fi
            echo "ğŸš€ Deploying to $TARGET_GROUP group, shutting down $OLD_GROUP group later."

            docker compose -f docker-compose.yml -p $TARGET_GROUP up -d --build

            echo "Waiting for $TARGET_GROUP to be healthy..."
            sleep 30

            echo "Switching reverse-proxy to $TARGET_GROUP..."
            sed "s/##TARGET_GROUP##/$TARGET_GROUP/g" ./nginx-proxy/nginx.template.conf > ./nginx-proxy/nginx.conf
            docker restart ubuntu-proxy-1 || true

            docker compose -f docker-compose.yml -p $OLD_GROUP down || true
            echo "ğŸ§¹ Cleaned up $OLD_GROUP group."

            # --- 4. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ ì´ë¯¸ì§€ ì •ë¦¬ ---
            echo "ğŸ§¹ Cleaning up unused docker images..."
            docker image prune -a -f
