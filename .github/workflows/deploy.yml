# .github/workflows/deploy.yml

name: Deploy Spring Boot + React to EC2 (Blue-Green)

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    name: Build and Deploy (Blue-Green)
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v3

      # --- CI: Build Artifacts ---
      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission to gradlew
        run: chmod +x ./backend/gradlew

      - name: 🛠️ Build Spring Boot with Gradle
        run: ./gradlew build -x test
        working-directory: ./backend

      - name: 🧱 Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: 🧾 Build React App
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      # --- 💡 변경점 1: 배포에 필요한 파일만 모아 deploy 폴더 생성 ---
      - name: 📁 Prepare deployment structure
        run: |
          # 배포에 필요한 폴더 구조를 미리 생성합니다.
          mkdir -p ./deploy/backend/build/libs
          mkdir -p ./deploy/frontend
          mkdir -p ./deploy/nginx
          mkdir -p ./deploy/nginx-proxy

          # 백엔드 관련 파일 복사 (Dockerfile + 빌드 결과물)
          cp ./backend/Dockerfile ./deploy/backend/
          cp ./backend/build/libs/*.jar ./deploy/backend/build/libs/

          # 프론트엔드 관련 파일 복사 (빌드 결과물)
          cp -r ./frontend/dist ./deploy/frontend/

          # 서비스 Nginx 관련 파일 복사 (Dockerfile + 설정 파일)
          cp -r ./nginx/* ./deploy/nginx/
          
          # Reverse Proxy Nginx 관련 파일 복사 (설정 템플릿)
          cp -r ./nginx-proxy/* ./deploy/nginx-proxy/

          # docker-compose.yml 복사
          cp ./docker-compose.yml ./deploy/
          
      - name: 🔍 Verify deployment structure
        run: |
          echo "📦 Deployment structure details:"
          ls -alh ./deploy
          echo "---"
          echo "💾 Total size of deployment folder:"
          du -sh ./deploy          

      # --- CD: Deploy to Server ---
      - name: 🚚 Transfer Build Artifacts to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # 💡 변경점 2: deploy 폴더의 내용물을 서버로 전송
          source: "./deploy/*"
          target: "~/app"
          strip_components: 1 # deploy 폴더 자체는 제외하고 내용물만 보냅니다.

      - name: 🚀 Deploy to EC2 with SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 서버의 ~/app 폴더로 이동
            cd ~/app

            # 1. .env 파일 동적 생성 (보안 강화)
            echo "DB_URL=${{ secrets.DB_URL }}" > .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}" >> .env
            echo "DISCORD_CLIENT_SECRET=${{ secrets.DISCORD_CLIENT_SECRET }}" >> .env
            echo "DISCORD_REDIRECT_URI=${{ secrets.DISCORD_REDIRECT_URI }}" >> .env

            # 2. 현재 실행 중인 그룹 확인하여 다음 타겟 그룹 결정
            # 컨테이너 이름은 docker-compose.yml에 정의된 서비스 이름(nginx)을 기준으로 찾습니다.
            IS_BLUE_RUNNING=$(docker ps --filter "name=blue-nginx-1" --format "{{.Names}}")
            if [ -n "$IS_BLUE_RUNNING" ]; then
              TARGET_GROUP=green
              OLD_GROUP=blue
            else
              TARGET_GROUP=blue
              OLD_GROUP=green
            fi
            echo "🚀 Deploying to $TARGET_GROUP group, shutting down $OLD_GROUP group later."

            # 💡 변경점 3: --build 옵션으로 서버에서 이미지를 빌드하도록 수정
            # -p 옵션으로 프로젝트 이름을 지정하여 컨테이너 이름에 접두사(blue/green)를 붙입니다.
            docker compose -f docker-compose.yml -p $TARGET_GROUP up -d --build

            # 4. 새 그룹이 정상적으로 실행될 때까지 대기 (Health Check)
            echo "Waiting for $TARGET_GROUP to be healthy..."
            sleep 30 # 실제 운영에서는 API 헬스체크 엔드포인트를 호출하는 방식으로 개선

            # 5. '교통 경찰' Nginx의 설정을 새 그룹으로 변경
            echo "Switching reverse-proxy to $TARGET_GROUP..."
            # nginx.template.conf 파일이 nginx-proxy 폴더 안에 있다고 가정
            sed "s/##TARGET_GROUP##/$TARGET_GROUP/g" ./nginx-proxy/nginx.template.conf > ./nginx-proxy/nginx.conf

            # 6. '교통 경찰' Nginx 재시작하여 설정 적용
            # reverse-proxy 컨테이너는 docker-compose.yml이 아닌 별도로 실행되고 있다고 가정
            docker restart reverse-proxy
            echo "✅ Switched to $TARGET_GROUP successfully!"

            # 7. 이전 버전 그룹 컨테이너 정리
            docker compose -f docker-compose.yml -p $OLD_GROUP down --volumes || true
            echo "🧹 Cleaned up $OLD_GROUP group."
