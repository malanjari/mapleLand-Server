# .github/workflows/deploy.yml

name: Build on GitHub and Deploy to EC2

on:
  push:
    branches:
      - deploy

jobs:
  # -------------------- 1. ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ --------------------
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout source code
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ–¼ï¸ Build and push Backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/maple-backend:latest

      - name: ğŸ–¼ï¸ Build and push Frontend image
        uses: docker/build-push-action@v4
        with:
          context: . # Dockerfileì´ ìˆëŠ” ìœ„ì¹˜ë¥¼ ì§€ì •
          file: ./nginx/Dockerfile # Frontend Dockerfile ê²½ë¡œ
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/maple-frontend:latest

  # -------------------- 2. EC2ì— ë°°í¬ --------------------
  deploy:
    name: Deploy to EC2
    needs: build # build ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë©ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Connect to EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 5m # ë°°í¬ ì‹œê°„ì´ ì§§ì•„ì¡Œìœ¼ë¯€ë¡œ íƒ€ì„ì•„ì›ƒì„ ì¤„ì—¬ë„ ë©ë‹ˆë‹¤.
          script: |
            # --- 0. ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë³´ì¥ ---
            if [ ! "$(docker ps -q -f name=maple-db)" ]; then
              echo "Database container not found. Starting a new one..."
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" > ~/db.env
              docker compose -f ~/docker-compose.db.yml --env-file ~/db.env up -d
              rm ~/db.env
            fi

            # --- 1. ìµœì‹  ì†ŒìŠ¤ì½”ë“œ ë° .env íŒŒì¼ ì¤€ë¹„ ---
            # docker-compose.yml íŒŒì¼ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ìœ ì§€í•˜ê¸° ìœ„í•´ git pull ì‹¤í–‰
            if [ ! -d "~/app" ]; then
              git clone -b deploy https://github.com/malanjari/mapleLand-Server.git ~/app
            fi
            cd ~/app
            git pull origin deploy

            # .env íŒŒì¼ ìƒì„±
            echo "DB_URL=${{ secrets.DB_URL }}" > .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}" >> .env
            echo "DISCORD_CLIENT_SECRET=${{ secrets.DISCORD_CLIENT_SECRET }}" >> .env
            echo "DISCORD_REDIRECT_URI=${{ secrets.DISCORD_REDIRECT_URI }}" >> .env
            echo "FRONTEND_REDIRECT_URL=${{ secrets.FRONTEND_REDIRECT_URL }}" >> .env
            echo "DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }}" >> .env

            # --- 2. Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ ë°›ì•„ì˜¤ê¸° ---
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            docker pull ${{ secrets.DOCKER_USERNAME }}/maple-backend:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/maple-frontend:latest

            # --- 3. Dockerë¡œ ë¸”ë£¨/ê·¸ë¦° ë°°í¬ ---
            IS_BLUE_RUNNING=$(docker ps --filter "name=blue-nginx-1" --format "{{.Names}}")
            if [ -n "$IS_BLUE_RUNNING" ]; then
              TARGET_GROUP=green
              OLD_GROUP=blue
            else
              TARGET_GROUP=blue
              OLD_GROUP=green
            fi
            echo "ğŸš€ Deploying to $TARGET_GROUP group, shutting down $OLD_GROUP group later."

            # ì´ì „ ê·¸ë£¹ ì¤‘ì§€ (ALB ì‚¬ìš© ì‹œ í¬íŠ¸ ì¶©ëŒ ë°©ì§€)
            docker compose -f docker-compose.yml -p $OLD_GROUP down || true

            # ìƒˆë¡œìš´ ê·¸ë£¹ ì‹¤í–‰ (ì´ì œ ë¹Œë“œ ì—†ì´ ë°”ë¡œ ì‹¤í–‰)
            docker compose -f docker-compose.yml -p $TARGET_GROUP up -d

            echo "âœ… Deployment to $TARGET_GROUP completed!"

            # --- 4. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ ì´ë¯¸ì§€ ì •ë¦¬ ---
            docker image prune -a -f
