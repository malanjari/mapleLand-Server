# .github/workflows/deploy.yml

name: Deploy Spring Boot + React to EC2 (Blue-Green)

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    name: Build and Deploy (Blue-Green)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v3

      # --- CI: Build Artifacts ---
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission to gradlew
        run: chmod +x ./backend/gradlew

      - name: ğŸ› ï¸ Build Spring Boot with Gradle
        run: ./gradlew build -x test
        working-directory: ./backend

      - name: ğŸ§± Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: ğŸ§¾ Build React App
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      # --- ğŸ’¡ ë³€ê²½ì  1: ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë§Œ ëª¨ì•„ deploy í´ë” ìƒì„± ---
      - name: ğŸ“ Prepare deployment structure
        run: |
          # ë°°í¬ì— í•„ìš”í•œ í´ë” êµ¬ì¡°ë¥¼ ë¯¸ë¦¬ ìƒì„±í•©ë‹ˆë‹¤.
          mkdir -p ./deploy/backend/build/libs
          mkdir -p ./deploy/frontend
          mkdir -p ./deploy/nginx
          mkdir -p ./deploy/nginx-proxy

          # ë°±ì—”ë“œ ê´€ë ¨ íŒŒì¼ ë³µì‚¬ (Dockerfile + ë¹Œë“œ ê²°ê³¼ë¬¼)
          cp ./backend/Dockerfile ./deploy/backend/
          cp ./backend/build/libs/*.jar ./deploy/backend/build/libs/

          # í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨ íŒŒì¼ ë³µì‚¬ (ë¹Œë“œ ê²°ê³¼ë¬¼)
          cp -r ./frontend/dist ./deploy/frontend/

          # ì„œë¹„ìŠ¤ Nginx ê´€ë ¨ íŒŒì¼ ë³µì‚¬ (Dockerfile + ì„¤ì • íŒŒì¼)
          cp -r ./nginx/* ./deploy/nginx/
          
          # Reverse Proxy Nginx ê´€ë ¨ íŒŒì¼ ë³µì‚¬ (ì„¤ì • í…œí”Œë¦¿)
          cp -r ./nginx-proxy/* ./deploy/nginx-proxy/

          # docker-compose.yml ë³µì‚¬
          cp ./docker-compose.yml ./deploy/
          
      - name: ğŸ” Verify deployment structure
        run: |
          echo "ğŸ“¦ Deployment structure details:"
          ls -alh ./deploy
          echo "---"
          echo "ğŸ’¾ Total size of deployment folder:"
          du -sh ./deploy          

      # --- CD: Deploy to Server ---
      - name: ğŸšš Transfer Build Artifacts to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # ğŸ’¡ ë³€ê²½ì  2: deploy í´ë”ì˜ ë‚´ìš©ë¬¼ì„ ì„œë²„ë¡œ ì „ì†¡
          source: "./deploy/*"
          target: "~/app"
          strip_components: 1 # deploy í´ë” ìì²´ëŠ” ì œì™¸í•˜ê³  ë‚´ìš©ë¬¼ë§Œ ë³´ëƒ…ë‹ˆë‹¤.

      - name: ğŸš€ Deploy to EC2 with SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ì„œë²„ì˜ ~/app í´ë”ë¡œ ì´ë™
            cd ~/app

            # 1. .env íŒŒì¼ ë™ì  ìƒì„± (ë³´ì•ˆ ê°•í™”)
            echo "DB_URL=${{ secrets.DB_URL }}" > .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}" >> .env
            echo "DISCORD_CLIENT_SECRET=${{ secrets.DISCORD_CLIENT_SECRET }}" >> .env
            echo "DISCORD_REDIRECT_URI=${{ secrets.DISCORD_REDIRECT_URI }}" >> .env

            # 2. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ê·¸ë£¹ í™•ì¸í•˜ì—¬ ë‹¤ìŒ íƒ€ê²Ÿ ê·¸ë£¹ ê²°ì •
            # ì»¨í…Œì´ë„ˆ ì´ë¦„ì€ docker-compose.ymlì— ì •ì˜ëœ ì„œë¹„ìŠ¤ ì´ë¦„(nginx)ì„ ê¸°ì¤€ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.
            IS_BLUE_RUNNING=$(docker ps --filter "name=blue-nginx-1" --format "{{.Names}}")
            if [ -n "$IS_BLUE_RUNNING" ]; then
              TARGET_GROUP=green
              OLD_GROUP=blue
            else
              TARGET_GROUP=blue
              OLD_GROUP=green
            fi
            echo "ğŸš€ Deploying to $TARGET_GROUP group, shutting down $OLD_GROUP group later."

            # ğŸ’¡ ë³€ê²½ì  3: --build ì˜µì…˜ìœ¼ë¡œ ì„œë²„ì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ë„ë¡ ìˆ˜ì •
            # -p ì˜µì…˜ìœ¼ë¡œ í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì§€ì •í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì´ë¦„ì— ì ‘ë‘ì‚¬(blue/green)ë¥¼ ë¶™ì…ë‹ˆë‹¤.
            docker compose -f docker-compose.yml -p $TARGET_GROUP up -d --build

            # 4. ìƒˆ ê·¸ë£¹ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë  ë•Œê¹Œì§€ ëŒ€ê¸° (Health Check)
            echo "Waiting for $TARGET_GROUP to be healthy..."
            sleep 30 # ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” API í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ê°œì„ 

            # 5. 'êµí†µ ê²½ì°°' Nginxì˜ ì„¤ì •ì„ ìƒˆ ê·¸ë£¹ìœ¼ë¡œ ë³€ê²½
            echo "Switching reverse-proxy to $TARGET_GROUP..."
            # nginx.template.conf íŒŒì¼ì´ nginx-proxy í´ë” ì•ˆì— ìˆë‹¤ê³  ê°€ì •
            sed "s/##TARGET_GROUP##/$TARGET_GROUP/g" ./nginx-proxy/nginx.template.conf > ./nginx-proxy/nginx.conf

            # 6. 'êµí†µ ê²½ì°°' Nginx ì¬ì‹œì‘í•˜ì—¬ ì„¤ì • ì ìš©
            # reverse-proxy ì»¨í…Œì´ë„ˆëŠ” docker-compose.ymlì´ ì•„ë‹Œ ë³„ë„ë¡œ ì‹¤í–‰ë˜ê³  ìˆë‹¤ê³  ê°€ì •
            docker restart reverse-proxy
            echo "âœ… Switched to $TARGET_GROUP successfully!"

            # 7. ì´ì „ ë²„ì „ ê·¸ë£¹ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker compose -f docker-compose.yml -p $OLD_GROUP down --volumes || true
            echo "ğŸ§¹ Cleaned up $OLD_GROUP group."
